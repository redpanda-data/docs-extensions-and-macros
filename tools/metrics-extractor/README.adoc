= Redpanda Metrics Extractor
:description: Automated extraction of metrics from Redpanda source code using tree-sitter
:page-categories: Development, Documentation, Automation

This tool automatically extracts Redpanda metrics from C++ source code using tree-sitter parsing. It identifies metrics created with various Seastar and Redpanda metric constructors and generates comprehensive documentation.

== Overview

The metrics extractor uses tree-sitter to parse C++ source code and identify metrics created with these constructors:

* `sm::make_gauge`
* `sm::make_counter`
* `sm::make_histogram`
* `sm::make_total_bytes`
* `sm::make_derive`
* `ss::metrics::make_total_operations`
* `ss::metrics::make_current_bytes`

For each metric found, it extracts:

* Metric name
* Type (gauge, counter, histogram)
* Description
* Potential labels
* Source file location
* Constructor used

== Prerequisites

* Python 3.8 or higher
* Git
* Build tools (gcc/clang for compiling tree-sitter)

== Installation

1. Set up the Python virtual environment:
+
[source,bash]
----
make setup-venv
----

2. Install dependencies:
+
[source,bash]
----
make install-deps
----

== Usage

=== Extract Metrics from Redpanda Repository

Extract metrics from a specific Redpanda version:

[source,bash]
----
make build TAG=v23.3.1
----

Extract metrics from the development branch:

[source,bash]
----
make build TAG=dev
----

=== Extract Metrics from Local Repository

If you have a local Redpanda repository:

[source,bash]
----
make extract-local REDPANDA_PATH=/path/to/redpanda
----

=== Manual Extraction

Run the extractor directly:

[source,bash]
----
python metrics_extractor.py /path/to/redpanda/src \
  --recursive \
  --output metrics.json \
  --asciidoc metrics.adoc \
  --filter-namespace redpanda \
  --verbose
----

== Output Files

The extractor generates several output files:

=== JSON Output (`metrics.json`)

Contains structured metric data:

[source,json]
----
{
  "metrics": {
    "redpanda_kafka_requests_total": {
      "name": "redpanda_kafka_requests_total",
      "type": "counter",
      "description": "Total number of Kafka requests",
      "labels": ["request_type", "status"],
      "constructor": "make_counter",
      "files": [{"file": "src/v/kafka/server/handlers/handler.cc", "line": 45}]
    }
  },
  "statistics": {
    "total_metrics": 150,
    "by_type": {"counter": 75, "gauge": 60, "histogram": 15},
    "by_constructor": {"make_counter": 75, "make_gauge": 60, "make_histogram": 15},
    "with_description": 140,
    "with_labels": 85
  }
}
----

=== AsciiDoc Output (`metrics.adoc`)

Human-readable documentation in AsciiDoc format:

[source,asciidoc]
----
=== redpanda_kafka_requests_total

Total number of Kafka requests

*Type*: counter

*Labels*:

- `request_type`
- `status`

*Source*: `src/v/kafka/server/handlers/handler.cc`

---
----

== Command Line Options

=== metrics_extractor.py

[source,bash]
----
python metrics_extractor.py [OPTIONS] PATH

Arguments:
  PATH                  Path to Redpanda source directory

Options:
  -r, --recursive       Search for C++ files recursively
  -o, --output FILE     Output JSON file (default: metrics.json)
  -a, --asciidoc FILE   Generate AsciiDoc output file
  --filter-namespace NS Filter metrics by namespace (e.g., redpanda)
  --treesitter-dir DIR  Tree-sitter directory (default: tree-sitter)
  --treesitter-lib FILE Tree-sitter library file
  -v, --verbose         Enable verbose logging
  -h, --help           Show help message
----

=== compare_metrics.py

[source,bash]
----
python compare_metrics.py [OPTIONS] METRICS_FILE

Arguments:
  METRICS_FILE          JSON file with extracted metrics

Options:
  --existing FILE       Existing metrics JSON for comparison
  --output FILE         Output comparison report to JSON
  -v, --verbose         Verbose logging
  -h, --help           Show help message
----

== Integration with Documentation Pipeline

The metrics extractor integrates with the existing documentation automation:

=== Adding to doc-tools.js

Add the metrics extraction command to the CLI:

[source,javascript]
----
automation
  .command('metric-docs')
  .description('Generate metrics documentation from Redpanda source code')
  .option('--tag <tag>', 'Git tag or branch to extract from', 'dev')
  .action((options) => {
    const cwd = path.resolve(__dirname, '../tools/metrics-extractor');
    const make = spawnSync('make', ['build', `TAG=${options.tag}`], 
                          { cwd, stdio: 'inherit' });
    if (make.status !== 0) process.exit(make.status);
  });
----

=== Autogenerated Directory Structure

The extractor follows the same pattern as property-extractor:

----
autogenerated/
├── v23.3.1/
│   └── metrics/
│       ├── metrics.json
│       └── metrics.adoc
└── dev/
    └── metrics/
        ├── metrics.json
        └── metrics.adoc
----

== Development

=== Running Tests

[source,bash]
----
make test
----

=== Code Formatting

[source,bash]
----
make format
----

=== Linting

[source,bash]
----
make lint
----

== Tree-sitter Queries

The extractor uses sophisticated tree-sitter queries to identify metric constructors. Here's an example query for `sm::make_gauge`:

[source,scheme]
----
(call_expression
    function: (qualified_identifier
        scope: (namespace_identifier) @namespace
        name: (identifier) @function_name
        (#match? @namespace "sm")
        (#match? @function_name "make_gauge")
    )
    arguments: (argument_list
        (string_literal) @metric_name
        . *
        (call_expression
            function: (qualified_identifier
                scope: (namespace_identifier) @desc_namespace
                name: (identifier) @desc_function
                (#match? @desc_namespace "sm")
                (#match? @desc_function "description")
            )
            arguments: (argument_list
                (string_literal) @description
            )
        )?
    )
)
----

== Troubleshooting

=== Tree-sitter Compilation Issues

If tree-sitter fails to compile:

1. Ensure you have build tools installed:
   * Linux: `sudo apt install build-essential`
   * macOS: `xcode-select --install`
   * Windows: Install Visual Studio Build Tools

2. Check Python version (3.8+ required)

3. Clear tree-sitter cache:
+
[source,bash]
----
make clean
----

=== Missing Metrics

If expected metrics are not found:

1. Check if the constructor patterns match the query
2. Verify file paths and namespaces
3. Enable verbose logging to see parsing details
4. Check for C++ syntax errors in source files

=== Performance Issues

For large codebases:

1. Use `--filter-namespace` to limit scope
2. Process specific directories instead of entire codebase
3. Increase system memory if available

== Contributing

When adding support for new metric constructors:

1. Add the tree-sitter query to `METRICS_QUERIES` in `metrics_parser.py`
2. Update `FUNCTION_TO_TYPE` mapping
3. Add tests for the new constructor pattern
4. Update documentation

== Examples

=== Extract Specific Namespace

[source,bash]
----
python metrics_extractor.py /path/to/redpanda/src \
  --filter-namespace redpanda \
  --recursive \
  --output redpanda_metrics.json
----

=== Compare with Previous Version

[source,bash]
----
# Extract current metrics
make build TAG=dev

# Extract previous version
make build TAG=v23.3.1

# Compare
python compare_metrics.py autogenerated/dev/metrics/metrics.json \
  --existing autogenerated/v23.3.1/metrics/metrics.json \
  --output comparison_report.json
----

=== Generate Documentation Only

[source,bash]
----
python metrics_extractor.py /path/to/redpanda/src \
  --asciidoc redpanda_metrics.adoc \
  --filter-namespace redpanda
----
