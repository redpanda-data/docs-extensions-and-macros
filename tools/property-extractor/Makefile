.PHONY: build venv clean redpanda-git treesitter generate-docs check

# Default tag (can be overridden via `make TAG=v25.1.1`)
TAG       ?= dev

# Derive a ‚Äúmajor.minor‚Äù or rc identifier from TAG for folder naming
VERSION := $(shell \
  if echo "$(TAG)" | grep -qE '^v?[0-9]+\.[0-9]+'; then \
	echo "$(TAG)" \
	  | sed -E 's/^v?([0-9]+\.[0-9]+)(\.[0-9]+)?(-rc[0-9]+)?.*/\1\3/' \
	  | sed 's/-rc/rc/'; \
  else \
	echo "$(TAG)"; \
  fi)

# Paths
REPO_ROOT     := $(shell git rev-parse --show-toplevel)
MODULE_ROOT   := $(shell cd "$(dir $(realpath $(lastword $(MAKEFILE_LIST))))"/../.. && pwd)
TOOL_ROOT     := $(MODULE_ROOT)/tools/property-extractor
TMP_ROOT      := $(TOOL_ROOT)/tmp
REDPANDA_SRC  := $(TMP_ROOT)/redpanda
TREESITTER_DIR:= $(TOOL_ROOT)/tree-sitter/tree-sitter-cpp
VENV          := $(TOOL_ROOT)/tmp/redpanda-property-extractor-venv
PYTHON        := $(VENV)/bin/python
TREE_SITTER   := npx tree-sitter

# Output directory configuration (can be overridden by environment variables)
OUTPUT_ASCIIDOC_DIR      ?= $(REPO_ROOT)/autogenerated/$(TAG)/properties/pages
OUTPUT_JSON_DIR          ?= $(REPO_ROOT)/autogenerated/$(TAG)/properties
OUTPUT_AUTOGENERATED_DIR ?= $(REPO_ROOT)/autogenerated/$(TAG)/properties
FINAL_OUTPUT_DIR         ?= $(REPO_ROOT)/modules/reference/pages

# --- Main build: venv, fetch code, build parser, extract & docgen ---
build: venv redpanda-git treesitter
	@echo "üîß Building with Redpanda tag: $(TAG)"
	@mkdir -p $(TOOL_ROOT)/gen
	@if [ -n "$(OVERRIDES)" ] && [ ! -f "$(OVERRIDES)" ]; then \
	  echo "‚ùå Error: Overrides file '$(OVERRIDES)' does not exist."; \
	  echo "   Please check the path or omit the OVERRIDES variable to continue without overrides."; \
	  exit 1; \
	fi
	@cd $(TOOL_ROOT) && \
	  $(PYTHON) -W ignore::FutureWarning property_extractor.py \
		--recursive \
		--path $(REDPANDA_SRC) \
		--output gen/properties-output.json \
		--enhanced-output gen/$(TAG)-properties.json \
		$(if $(OVERRIDES),$(if $(shell [ -f "$(OVERRIDES)" ] && echo exists),--overrides $(OVERRIDES),),)
	@echo "‚úÖ JSON generated at $(TOOL_ROOT)/gen/properties-output.json"
	@echo "‚úÖ Enhanced JSON (with overrides) generated at $(TOOL_ROOT)/gen/$(TAG)-properties.json"
	@$(MAKE) generate-docs

# --- Ensure Python venv & dependencies ---
venv: $(TOOL_ROOT)/requirements.txt
	@if [ ! -d "$(VENV)" ]; then \
	  echo "üêç Creating virtual environment in $(VENV)..."; \
	  python3 -m venv $(VENV); \
	  $(VENV)/bin/pip install --upgrade pip --quiet; \
	  $(VENV)/bin/pip install --no-cache-dir -r $<; \
	else \
	  echo "üêç Virtual environment already exists at $(VENV)"; \
	fi

# --- Clean out all generated state ---
clean:
	@echo "üßπ Cleaning up‚Ä¶"
	@rm -rf $(VENV) $(TMP_ROOT) $(REPO_ROOT)/autogenerated

# --- Clone or update Redpanda, checkout TAG or default branch ---
redpanda-git:
	@mkdir -p "$(TMP_ROOT)"
	@echo "üîÑ Cloning/updating Redpanda into $(REDPANDA_SRC)‚Ä¶"
	@if [ -d "$(REDPANDA_SRC)" ]; then \
	  git -C "$(REDPANDA_SRC)" fetch --all --tags -q; \
	else \
	  git clone -q https://github.com/redpanda-data/redpanda.git "$(REDPANDA_SRC)"; \
	fi; \
	if git -C "$(REDPANDA_SRC)" rev-parse --verify -q "$(TAG)" >/dev/null; then \
	  echo "üîñ Checking out '$(TAG)'"; \
	  git -C "$(REDPANDA_SRC)" checkout -q "$(TAG)"; \
	else \
	  DEFAULT_BRANCH=$$(git -C "$(REDPANDA_SRC)" symbolic-ref --short refs/remotes/origin/HEAD); \
	  echo "‚ö†Ô∏è Tag '$(TAG)' not found; falling back to '$${DEFAULT_BRANCH}'"; \
	  git -C "$(REDPANDA_SRC)" checkout -q "$${DEFAULT_BRANCH}"; \
	fi

# --- Clone Tree-sitter grammar & generate parser ---
treesitter:
	@echo "üå≤ Ensuring tree-sitter-cpp grammar‚Ä¶"
	@if [ ! -d "$(TREESITTER_DIR)" ]; then \
	  git clone https://github.com/tree-sitter/tree-sitter-cpp.git "$(TREESITTER_DIR)"; \
	fi
	@echo "üîÑ Ensuring tree-sitter-cpp is at compatible version v0.20.5‚Ä¶"
	@cd "$(TREESITTER_DIR)" && \
	  git fetch --tags -q && \
	  git checkout -q v0.20.5
	@echo "üîß Generating parser in $(TREESITTER_DIR)‚Ä¶"
	@cd "$(TREESITTER_DIR)" && npm install --silent && $(TREE_SITTER) generate

# --- Install Node.js dependencies for Handlebars ---
node-deps:
	@echo "üì¶ Installing Node.js dependencies‚Ä¶"
	@cd $(TOOL_ROOT) && npm install --silent

# --- Turn the JSON into AsciiDoc pages under the specified output directories ---
generate-docs: node-deps
	@echo "üìù Generating AsciiDoc pages in $(OUTPUT_ASCIIDOC_DIR)‚Ä¶"
	@mkdir -p "$(OUTPUT_ASCIIDOC_DIR)"
	@mkdir -p "$(OUTPUT_JSON_DIR)"
	@# Use the enhanced properties file (with overrides) for documentation generation if it exists
	@if [ -f "$(TOOL_ROOT)/gen/$(TAG)-properties.json" ]; then \
	  cd $(TOOL_ROOT) && \
	    node generate-handlebars-docs.js "gen/$(TAG)-properties.json" "$(OUTPUT_ASCIIDOC_DIR)"; \
	else \
	  cd $(TOOL_ROOT) && \
	    node generate-handlebars-docs.js "gen/properties-output.json" "$(OUTPUT_ASCIIDOC_DIR)"; \
	fi
	@echo "üìÑ Copying properties JSON files to $(OUTPUT_JSON_DIR)‚Ä¶"
	@cp "$(TOOL_ROOT)/gen/properties-output.json" "$(OUTPUT_JSON_DIR)/"
	@if [ -f "$(TOOL_ROOT)/gen/$(TAG)-properties.json" ]; then \
	  cp "$(TOOL_ROOT)/gen/$(TAG)-properties.json" "$(OUTPUT_JSON_DIR)/"; \
	fi
	@# Copy AsciiDoc files to final output directory if different from autogenerated
	@if [ "$(OUTPUT_ASCIIDOC_DIR)" != "$(FINAL_OUTPUT_DIR)" ]; then \
	  echo "üìÑ Copying AsciiDoc files to final output directory $(FINAL_OUTPUT_DIR)‚Ä¶"; \
	  mkdir -p "$(FINAL_OUTPUT_DIR)"; \
	  cp -r "$(OUTPUT_ASCIIDOC_DIR)"/* "$(FINAL_OUTPUT_DIR)/"; \
	fi
	@# Copy JSON files to modules/reference/examples if not already there
	@if [ "$(OUTPUT_JSON_DIR)" != "$(REPO_ROOT)/modules/reference/examples" ]; then \
	  echo "üìÑ Copying JSON files to modules/reference/examples‚Ä¶"; \
	  mkdir -p "$(REPO_ROOT)/modules/reference/examples"; \
	  cp "$(TOOL_ROOT)/gen/properties-output.json" "$(REPO_ROOT)/modules/reference/examples/"; \
	  if [ -f "$(TOOL_ROOT)/gen/$(TAG)-properties.json" ]; then \
	    cp "$(TOOL_ROOT)/gen/$(TAG)-properties.json" "$(REPO_ROOT)/modules/reference/examples/"; \
	  fi; \
	fi
	@echo "‚úÖ Docs generated at $(OUTPUT_AUTOGENERATED_DIR)"

# --- Debug helper to print all the key paths/vars ---
check:
	@echo "MODULE_ROOT:              $(MODULE_ROOT)"
	@echo "TOOL_ROOT:                $(TOOL_ROOT)"
	@echo "REDPANDA_SRC:             $(REDPANDA_SRC)"
	@echo "TREESITTER:               $(TREESITTER_DIR)"
	@echo "VENV:                     $(VENV)"
	@echo "PYTHON:                   $(PYTHON)"
	@echo "OUTPUT_ASCIIDOC_DIR:      $(OUTPUT_ASCIIDOC_DIR)"
	@echo "OUTPUT_JSON_DIR:          $(OUTPUT_JSON_DIR)"
	@echo "OUTPUT_AUTOGENERATED_DIR: $(OUTPUT_AUTOGENERATED_DIR)"
	@echo "FINAL_OUTPUT_DIR:         $(FINAL_OUTPUT_DIR)"
